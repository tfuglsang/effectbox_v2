# EffectBox v2 - AI Assistant Instructions

## AI Assistant Role
You are an **expert on the STM32H747 microcontroller** and embedded audio DSP development. You have access to comprehensive STM32H7 documentation in the `stm32h7_docs/` folder. Use this knowledge to provide accurate, hardware-specific guidance.

## Project Overview
Real-time audio effects processor and guitar tuner for **STM32H747I-DISCO** (dual-core Cortex-M7/M4). Only the CM7 core runs application code; CM4 is minimal. Audio: 48kHz stereo via WM8994 codec, processed as mono internally.

**Scope**: CM7 (400MHz M7) runs the full application; CM4 (200MHz M4) is present but unused. All changes should target CM7 unless explicitly involving dual-core synchronization.

## STM32 Reference Documentation

### How to Use the Documentation (Context-Efficient Approach)
The `stm32h7_docs/` folder contains detailed STM32H7 documentation organized for efficient context usage:

1. **Start with the INDEX files** - Each manual has an index with chapter summaries and keywords:
   - `stm32h7_docs/STM32H747_REFERENCE_MANUAL/STM32H747_INDEX.md` - Hardware peripherals (SAI, DMA, GPIO, timers, etc.)
   - `stm32h7_docs/STM32_CORTEX_M7_PROGRAMMERS_MANUAL/STM32_CORTEX_M7_INDEX.md` - CM7 core programming (registers, instructions, NVIC, MPU, FPU, caches)
   - `stm32h7_docs/STM32_CORTEX_M4_PROGRAMMERS_MANUAL/STM32_CORTEX_M4_INDEX.md` - CM4 core programming
   - `stm32h7_docs/STM32H747XI_DISCOVERY_USER_MANUAL/STM32H747XI_DISCOVERY_USER_MANUAL_INDEX.md` - Discovery board hardware (pinouts, connectors, jumpers, LEDs)
   - `stm32h7_docs/WM8994/WM8994_INDEX.md` - WM8994 audio codec (inputs, outputs, I2S, clocking, registers, DRC, EQ)

2. **Read only what you need** - Index files contain keyword tables to identify relevant chapters. Load specific chapter folders only when detailed information is required.

3. **Chapter structure** - Each chapter is in its own subfolder (e.g., `54_54 Serial audio interface (SAI)/`) containing the full markdown content.

### Documentation Coverage
| Manual | Content | Index File |
|--------|---------|------------|
| **STM32H747 Reference Manual (RM0399)** | All hardware peripherals, memory map, clock tree, DMA, ADC, DAC, timers, communication interfaces, display controllers | `STM32H747_INDEX.md` |
| **Cortex-M7 Programming Manual (PM0253)** | CM7 core registers, instruction set, NVIC, SCB, MPU, FPU, cache maintenance | `STM32_CORTEX_M7_INDEX.md` |
| **Cortex-M4 Programming Manual (PM0214)** | CM4 core registers, instruction set, NVIC, SCB, MPU, FPU (single precision) | `STM32_CORTEX_M4_INDEX.md` |
| **STM32H747I-DISCO User Manual** | Discovery board: pin mapping, connectors, jumpers, LEDs, buttons, audio/camera interfaces, power domains | `STM32H747XI_DISCOVERY_USER_MANUAL_INDEX.md` |
| **WM8994 Audio Codec Datasheet** | Audio codec: analogue/digital inputs, headphone/speaker/line outputs, I2S/TDM interfaces, FLL clocking, DRC, EQ, registers | `WM8994_INDEX.md` |

### Common Peripheral Quick Reference
- **SAI (Audio)**: Reference Manual Chapter 54 - I2S/TDM configuration, DMA integration
- **WM8994 (Audio Codec)**: WM8994 Index - Input/output configuration, I2S setup, volume control, DRC/EQ
- **DMA/MDMA**: Reference Manual Chapters 15-18 - Buffer transfers, circular mode, DMAMUX
- **RCC (Clocks)**: Reference Manual Chapter 9 - PLLs, peripheral clocks, clock tree
- **GPIO**: Reference Manual Chapter 12 - Pin configuration, alternate functions
- **Timers**: Reference Manual Chapters 39-45 - PWM, interrupts, HRTIM
- **HSEM (Dual-core sync)**: Reference Manual Chapter 11 - Hardware semaphores for CM7/CM4
- **Cache**: Cortex-M7 Manual Section 4.8 - Cache maintenance operations
- **Board Pin Mapping**: Discovery User Manual Chapter 8 - MCU pin to board connector mapping
- **Board Connectors**: Discovery User Manual Chapter 7 - Audio, USB, camera connector pinouts

## Architecture

### Dual-Core CMake Structure
- Root `CMakeLists.txt` orchestrates both cores via `ExternalProject_Add`
- Each core has independent build: `CM7/build/` and `CM4/build/`
- Toolchain: `gcc-arm-none-eabi.cmake` with `-ffast-math` for DSP performance
- HAL code generated by STM32CubeMX → `mx-generated.cmake` (semi-auto, editable)

### Audio Pipeline Pattern
All effects inherit from `AudioEffect` base class ([../CM7/Inc/audio_effect.h](../CM7/Inc/audio_effect.h)):
```cpp
class MyEffect : public AudioEffect {
    void process(int16_t* samples, uint32_t num_samples) override;  // MONO only
    void reset() override;  // Clear delay lines, etc.
    // Optional: has_parameter(), adjust_parameter(), get_parameter_string()
};
```
`AudioPipeline` ([../CM7/Inc/audio_pipeline.h](../CM7/Inc/audio_pipeline.h)) chains effects and handles:
- Stereo→mono deinterleave at input, mono→stereo at output
- DWT cycle counter profiling per effect (zero overhead)

### Memory Layout
- Audio DMA buffers must be in D2 SRAM: `__attribute__((section(".ram_d2_data"))) alignas(32)`
- Cache coherency: call `SCB_InvalidateDCache_by_Addr` before read, `SCB_CleanDCache_by_Addr` after write

## Build & Test Workflow

### Building
```bash
cmake -B build/Debug -G Ninja     # Configure (one-time)
cmake --build build/Debug         # Build both CM7 and CM4

# Flash CM7 only:
STM32_Programmer_CLI -c port=SWD -w build/Debug/CM7/build/effectbox_v2_CM7.elf -rst
```

### Host-Side Unit Tests
```bash
cd tests
cmake -B build -S .
cmake --build build
./build/effectbox_tests          # Run all tests
./build/effectbox_tests "[effect_name]"  # Run specific suite
```
Tests validate DSP math, pitch detection, pipeline audio flow (NOT hardware-dependent code like DMA/SAI).

## Critical Audio Subsystem Patterns

### Audio Flow Architecture
1. **Input**: WM8994 codec captures stereo audio via SAI/I2S → DMA fills `audio_buffer` (D2 SRAM)
2. **Processing**: `AudioPipeline::process_interleaved()` deinterleaves stereo to mono, chains effects, re-interleaves
3. **Output**: DMA drains audio back to codec via SAI/I2S
4. **Callbacks**: `BSP_AUDIO_IN_HalfTransfer_CallBack` and `TransferComplete_CallBack` trigger processing in [../CM7/Src/main.cpp](../CM7/Src/main.cpp)

### Memory & Performance Critical Details
- **Audio buffers**: MUST be in D2 SRAM with `__attribute__((section(".ram_d2_data"))) alignas(32)` - see [../CM7/Src/main.cpp](../CM7/Src/main.cpp)
- **Cache coherency**: Call `SCB_InvalidateDCache_by_Addr()` before reading codec data, `SCB_CleanDCache_by_Addr()` after writing
- **DSP profiling**: Uses DWT cycle counter (`DWT->CYCCNT`) - zero overhead, accumulated per effect by `AudioPipeline` - visible on LCD in effects mode
- **Mono processing**: All effects process mono samples only. Stereo I/O is handled transparently by pipeline (L+R → average on input, same mono → L=R on output)

### Configuration Synchronization
**Critical**: Audio constants in [../CM7/Inc/app_common.h](../CM7/Inc/app_common.h) (sample rate, buffer sizes) MUST be kept in sync with `tests/mocks/app_common.h` for host tests to match target behavior.

## Key Conventions

### Adding New Audio Effects
1. Create header in `CM7/Inc/` inheriting `AudioEffect`
2. Process **mono int16_t** samples in-place
3. Add instance in [../CM7/Src/audio_effects_mode.cpp](../CM7/Src/audio_effects_mode.cpp)
4. Register with `audio_pipeline.add_effect(&my_effect)`
5. Use CMSIS-DSP (`arm_math.h`) for optimized math

### LCD/UI Updates
Use `LcdUtils::draw_text_fixed_width()` for flicker-free text ([../CM7/Inc/lcd_utils.h](../CM7/Inc/lcd_utils.h)). Always fill background before drawing text.

### Hardware Interaction
- Joystick: EXTI callbacks in `main.cpp`, debounced via `Joystick::DEBOUNCE_MS`
- Audio callbacks: `BSP_AUDIO_IN_HalfTransfer_CallBack` / `TransferComplete_CallBack`
- LEDs: `BSP_LED_Toggle(LED1)` for debug indicators

### Application Modes
Modes defined in `AppMode` enum ([../CM7/Inc/app_common.h](../CM7/Inc/app_common.h)):
- `INITIAL_MENU` → `AUDIO_EFFECTS`, `PITCH_DETECTION`, or `SPECTRUM_ANALYZER`
- Mode-specific code isolated in `*_mode.cpp` files in [../CM7/Src/](../CM7/Src/)

## Code Style
- Modern C++17 with `-fno-rtti -fno-exceptions` (embedded constraints)
- Use `constexpr` for constants, namespaces for grouping
- STM32 HAL wrapped in `extern "C" {}` blocks
- File headers: doxygen-style with `@file`, `@brief`, `@author`

## Testing
No unit test framework configured. Validate effects by:
1. Checking CPU profiling stats (displayed on LCD in effects mode)
2. Audio passthrough verification via line-in/line-out